# Changelog

## 2025-11-24

- **DOCS:** Created `README.md` with a comprehensive overview of the project, including features, data flow, and technologies used.
- **DOCS:** Created `project_overview.md` with a high-level overview of the project's architecture, components, and future improvements.
- **DOCS:** Created `CHANGELOG.md` to track changes to the project.
- **DOCS:** Added comments to explain each code block in `controllers/auth.js`.
- **DOCS:** Added comments to explain each code block in `public/animefetcher.js`.
- **DOCS:** Added comments to explain each code block in `routes/auth.js`.
- **DOCS:** Added comments to explain each code block in `routes/pages.js`.
- **DOCS:** Added comments to explain each code block in `views/dashboard.hbs`.
- **DOCS:** Added comments to explain each code block in `views/index.hbs`.
- **DOCS:** Added comments to explain each code block in `views/login.hbs`.
- **DOCS:** Added comments to explain each code block in `views/register.hbs`.
- **DOCS:** Added comments to explain each code block in `views/search.hbs`.
- **DOCS:** Added comments to explain each code block in `app.js`.
- **DOCS:** Shortened the project description in `README.md` to a maximum of 350 characters.
- **BUILD:** Created `.gitignore` file to exclude unnecessary files and directories from version control.
- **DOCS:** Updated `README.md` and `project_overview.md` to include information about the database seeding scripts.
- **DOCS:** Updated `README.md` to include a detailed "Database Setup" section with multiple options for setting up the database.
- **DOCS:** Added comments to explain each code block in `auto insert to db/autoinsert2.py`.
- **DOCS:** Added comments to explain each code block in `auto insert to db/randomwatchlist.py`.
- **DOCS:** Added comments to explain each code block in `auto insert to db/studiocatcher.py`.
- **DOCS:** Added comments to explain each code block in `auto insert to db/studiomapcreator.py`.

## 2025-12-05

- **FIX:** Resolved issue where `/focusanime/:animeId` API endpoint was returning null values.
- **FEAT:** Implemented client-side logic in `public/animefetcher.js` to fetch and display anime details dynamically on the `/anime/:animeId` page.
- **FIX:** Registered Handlebars 'json' helper in `app.js` to resolve 'Missing helper: json' error on anime details page for logged-in users.
- **FIX:** Updated Content Security Policy (CSP) in `app.js` to allow connections to `https://unpkg.com`, resolving dashboard loading issues.
- **FEAT:** Implemented commenting system for anime pages.
    - Added `comments` table to `database_creation.sql`.
    - Added `role` column to `user` table in `database_creation.sql` for RBAC.
    - Updated `user_inserts.sql` to assign 'admin' role to 'mirkolouis' and 'user' role to others.
    - Implemented API endpoints for comments:
        - `GET /api/anime/:animeId/comments` (accessible to all users).
        - `POST /api/anime/:animeId/comments` (requires logged-in user).
        - `DELETE /api/comments/:commentId` (requires admin role).
    - Added `ensureAdmin` middleware in `controllers/auth.js` for RBAC.
    - Updated frontend (`views/anime_details.hbs` and `public/animefetcher.js`) to display comments, show conditional comment form (login prompt for guests), and enable admin-only comment deletion.
- **FEAT:** Improved layout of anime details page (`views/anime_details.hbs`).
    - Reduced banner height to 1/4 of its previous height.
    - Reorganized anime image and title to be closer using a flexbox layout.
- **FIX:** Added theme switching functionality to `views/anime_details.hbs`.
- **FEAT:** Made "View Details" button in spotlight the same size as "Add to Watchlist" button.
- **FEAT:** Updated `autoinsert2.py` to `autoinsert3.py`. The new script dynamically generates studio and tag maps from their respective `.sql` files, making the data seeding process more self-contained. Also updated the pagination logic to be more robust by using the `has_next_page` flag from the Jikan API.
- **FIX:** Fixed a `KeyError: 'NO TAGS'` in `autoinsert3.py` by ensuring 'NO TAGS' is included in the `insert_tags.sql` file generated by `tagcatcher.py`.
- **DOCS:** Updated `README.md` with a more detailed and clearer "Set up the database" section, outlining two distinct paths for database setup and seeding.
- **DOCS:** Updated `project_overview.md` to reflect the new data seeding workflow with `autoinsert3.py`.
- **BUILD:** Created `auto insert to db/requirements.txt` listing Python dependencies (`aiohttp`, `tqdm`).
- **FEAT:** Updated Python data seeding scripts for enhanced performance and robustness:
    - Renamed `autoinsert2.py` to `autoinsert3.py`.
    - Integrated map creation logic into `autoinsert3.py`, making it more self-contained.
    - Implemented asynchronous API calls using `aiohttp` and `asyncio` for faster data fetching in `autoinsert3.py` and `studiocatcher2.py`.
    - Updated pagination logic in `autoinsert3.py` to use `has_next_page` for reliability.
    - Introduced `studiocatcher2.py` and `studiomapcreator2.py` for updated studio data processing.
- **DOCS:** Updated `README.md` to include detailed instructions for installing Python dependencies via `requirements.txt` and revised database setup steps for both manual SQL execution and full data seeding from scratch.
- **DOCS:** Updated `project_overview.md` to reflect the new Python data seeding scripts (`studiocatcher2.py`, `studiomapcreator2.py`, `autoinsert3.py`) and their asynchronous processing, clarifying the updated workflow and dependencies.
- **DOCS:** Added a note to `README.md` advising users to delete previously generated SQL and map files before running Python data seeding scripts to avoid complications.
- **FEAT:** Created `randomcomments.py` to generate random comments for a subset of animes, and updated it to generate 500 unique comments spread across 500 animes.
- **DOCS:** Updated `README.md` and `project_overview.md` to include information about the `randomcomments.py` script and the `insert_comments.sql` file.

## 2025-12-06

- **FIX:** Corrected a `ReferenceError` in `public/js/carousels.js` that was introduced during a previous refactoring, ensuring that dynamically created anime cards are rendered correctly.
- **FIX:** Prevented a `401 Unauthorized` error on the dashboard page for unauthenticated users by adding a check before fetching personalized spotlight data.
- **PERF:** Corrected the lazy loading implementation for images in all carousels and grids. The `src` attribute was being set incorrectly, causing images to load immediately instead of when they become visible. This improves initial page load performance and reduces unnecessary network requests.
- **DOCS:** Updated `README.md` to reflect the refactored and modularized client-side JavaScript file structure.
- **REFACTOR:** Extracted database connection logic from `app.js` into a new centralized configuration file: `config/database.js`. This improves separation of concerns and maintainability.
- **REFACTOR:** Created a new `services` directory and a `services/commentService.js` file. Moved the database query logic for fetching comments from `app.js` into `commentService.js`. The `GET /api/anime/:animeId/comments` endpoint in `app.js` now uses this new service. This is the first step towards a more modular architecture.
- **SECURITY:** Refactored all dynamic content rendering in `public/animefetcher.js` to prevent Cross-Site Scripting (XSS) vulnerabilities. Replaced all instances of `.innerHTML` with secure DOM creation methods (`document.createElement` and `.textContent`). This includes:
    - Comment sections (`fetchAndRenderComments`).
    - New, Upcoming, Recommended, Most Watchlisted, and Random anime carousels/grids.
    - Watchlist and Completed Watchlist views.
    - Search results view.
- **REFACTOR:** Moved all anime-related routes from `app.js` to a dedicated `routes/anime.js` file and their corresponding logic to `controllers/animeController.js`. This significantly cleans up `app.js` and improves the modularity of the application.
- **REFACTOR:** Moved all user-specific and comment-related routes from `app.js` to dedicated `routes/user.js` and `routes/comment.js` files, with their logic moved to `controllers/userController.js` and `controllers/commentController.js` respectively. The `app.js` file is now significantly smaller and only handles middleware and route registration.
- **PERFORMANCE:** Created `add_indexes.sql` to add database indexes to frequently queried columns, improving overall application performance.
- **REFACTOR:** Removed duplicate database connection logic from `controllers/auth.js` and replaced it with a reference to the central `config/database.js` module.
- **REFACTOR:** Split the monolithic `public/animefetcher.js` into smaller, more manageable modules:
    - `public/js/comments.js`: Handles all comment-related functionality.
    - `public/js/watchlist.js`: Handles all watchlist-related functionality.
    - `public/js/search.js`: Handles all search-related functionality.
    - `public/js/carousels.js`: Handles all carousel and spotlight functionality.
    - `public/js/utils.js`: Contains utility functions like `showAlert`.
- **REFACTOR:** Updated `anime_details.hbs`, `dashboard.hbs`, `index.hbs`, and `search.hbs` to load the new JavaScript modules.
- **REFACTOR:** Completed the frontend refactoring by moving the main `DOMContentLoaded` event listener to `public/js/main.js` and removing the now-obsolete `public/animefetcher.js` file. All pages now load the new, modular JavaScript files.
- **SECURITY:** Ran `npm audit fix` to patch 6 vulnerabilities (4 low, 1 moderate, 1 high) in project dependencies.
